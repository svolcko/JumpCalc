<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Jump">
<meta name="theme-color" content="#0a0e1a">
<title>Jump Analyzer</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap');

  :root {
    --bg: #0a0e1a;
    --surface: #131829;
    --surface2: #1a2035;
    --border: #252d45;
    --text: #e0e4f0;
    --text2: #7a8299;
    --text3: #4a5170;
    --blue: #4a8eff;
    --blue-dim: #2a4a80;
    --green: #2dd881;
    --green-dim: #1a5a3a;
    --red: #ff5c5c;
    --red-dim: #5a2020;
    --gold: #ffc44a;
    --gold-dim: #6a5020;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'DM Sans', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    min-height: 100dvh;
    padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
    overscroll-behavior: none;
  }

  .app { max-width: 480px; margin: 0 auto; padding: 16px 12px 100px; }

  .header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px; padding: 8px 4px; }
  .header h1 { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; color: #fff; }
  .header .badge {
    font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 500;
    color: var(--blue); background: rgba(74,142,255,0.12); padding: 3px 8px;
    border-radius: 20px; letter-spacing: 0.5px;
  }

  .tabs { display: flex; background: var(--surface); border-radius: 12px; padding: 3px; margin-bottom: 16px; }
  .tab {
    flex: 1; padding: 10px 0; border: none; background: none; color: var(--text2);
    font-family: inherit; font-size: 14px; font-weight: 600; border-radius: 10px;
    cursor: pointer; transition: all 0.2s; position: relative;
  }
  .tab.active { background: var(--surface2); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
  .tab .count {
    font-size: 10px; background: var(--blue-dim); color: var(--blue);
    padding: 1px 6px; border-radius: 8px; margin-left: 4px;
  }

  .card { background: var(--surface); border-radius: 14px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border); }
  .card-title {
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 1px; color: var(--text3); margin-bottom: 12px;
  }

  .video-box { background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 4px; position: relative; touch-action: none; }
  .video-box video { width: 100%; display: block; max-height: 50vh; object-fit: contain; transform-origin: center center; }
  .zoom-controls { display: flex; justify-content: center; gap: 8px; margin-bottom: 12px; }
  .zoom-btn {
    padding: 6px 16px; border: 1px solid var(--border); border-radius: 8px;
    background: var(--surface); color: var(--text2); font-family: 'JetBrains Mono', monospace;
    font-size: 13px; font-weight: 600; cursor: pointer;
  }
  .zoom-btn:active { background: var(--border); }
  .zoom-btn.active { border-color: var(--blue-dim); color: var(--blue); }

  .frame-display { text-align: center; padding: 8px 0; margin-bottom: 8px; }
  .frame-num { font-family: 'JetBrains Mono', monospace; font-size: 36px; font-weight: 700; color: #fff; line-height: 1; }
  .frame-total { font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--text3); margin-top: 2px; }
  .frame-time { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text2); margin-top: 4px; }

  .detect-info {
    background: rgba(74,142,255,0.08); border: 1px solid var(--blue-dim); border-radius: 10px;
    padding: 10px 12px; margin-bottom: 12px; font-size: 12px; color: var(--blue); line-height: 1.5;
  }
  .detect-info strong { color: #fff; }

  .scrubber-wrap { position: relative; padding: 8px 0; margin-bottom: 4px; }
  .scrubber {
    width: 100%; -webkit-appearance: none; appearance: none; height: 6px;
    border-radius: 3px; background: var(--surface2); outline: none;
  }
  .scrubber::-webkit-slider-thumb {
    -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%;
    background: var(--blue); border: 3px solid var(--bg); box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  }
  .marker { position: absolute; top: 4px; width: 3px; height: 14px; border-radius: 2px; pointer-events: none; z-index: 2; }
  .marker.takeoff { background: var(--green); }
  .marker.landing { background: var(--red); }
  .marker.contact-in { background: #ffa500; }
  .marker.contact-out { background: #c882ff; }

  .step-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; margin-bottom: 12px; }
  .step-btn {
    padding: 14px 0; border: none; border-radius: 10px; background: var(--surface2);
    color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 14px;
    font-weight: 600; cursor: pointer; border: 1px solid var(--border); transition: background 0.1s;
  }
  .step-btn:active { background: var(--border); }

  .mark-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
  .mark-btn {
    padding: 16px 12px; border: 2px solid; border-radius: 12px; font-family: inherit;
    font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.15s; text-align: center; line-height: 1.3;
  }
  .mark-btn.takeoff { background: rgba(45,216,129,0.08); border-color: var(--green-dim); color: var(--green); }
  .mark-btn.takeoff:active { background: rgba(45,216,129,0.2); }
  .mark-btn.takeoff.set { background: rgba(45,216,129,0.15); border-color: var(--green); }
  .mark-btn.landing { background: rgba(255,92,92,0.08); border-color: var(--red-dim); color: var(--red); }
  .mark-btn.landing:active { background: rgba(255,92,92,0.2); }
  .mark-btn.landing.set { background: rgba(255,92,92,0.15); border-color: var(--red); }
  .mark-btn.contact-in { background: rgba(255,165,0,0.08); border-color: #5a3a10; color: #ffa500; }
  .mark-btn.contact-in:active { background: rgba(255,165,0,0.2); }
  .mark-btn.contact-in.set { background: rgba(255,165,0,0.15); border-color: #ffa500; }
  .mark-btn.contact-out { background: rgba(200,130,255,0.08); border-color: #3a2060; color: #c882ff; }
  .mark-btn.contact-out:active { background: rgba(200,130,255,0.2); }
  .mark-btn.contact-out.set { background: rgba(200,130,255,0.15); border-color: #c882ff; }
  .mark-frame { display: block; font-family: 'JetBrains Mono', monospace; font-size: 11px; opacity: 0.7; margin-top: 2px; }

  .clear-link {
    display: block; text-align: center; background: none; border: none;
    color: var(--text3); font-family: inherit; font-size: 12px; cursor: pointer; padding: 8px; text-decoration: underline;
  }

  .results {
    background: linear-gradient(135deg, #0f1a33, var(--surface)); border: 1px solid var(--blue-dim);
    border-radius: 14px; padding: 16px; margin-bottom: 12px;
  }
  .results-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--blue); margin-bottom: 14px; }
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; }
  .stat { background: rgba(0,0,0,0.25); border-radius: 10px; padding: 10px 12px; text-align: center; }
  .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 700; color: #fff; }
  .stat-value.highlight { color: var(--gold); font-size: 28px; }
  .stat-label { font-size: 11px; color: var(--text2); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat.wide { grid-column: 1 / -1; }

  .log-form { display: flex; gap: 8px; }
  .log-input {
    flex: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
    background: var(--bg); color: var(--text); font-family: inherit; font-size: 14px; outline: none;
  }
  .log-input::placeholder { color: var(--text3); }
  .log-input:focus { border-color: var(--blue-dim); }
  .log-btn {
    padding: 12px 20px; border: none; border-radius: 10px; background: var(--blue);
    color: #fff; font-family: inherit; font-size: 14px; font-weight: 700; cursor: pointer; white-space: nowrap;
  }
  .log-btn:active { opacity: 0.8; }

  .load-row { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
  .load-btn {
    padding: 12px 24px; border: none; border-radius: 10px; background: var(--blue);
    color: #fff; font-family: inherit; font-size: 14px; font-weight: 700; cursor: pointer;
  }
  .load-btn:active { opacity: 0.8; }
  .record-btn {
    padding: 12px 18px; border: 2px solid var(--gold-dim); border-radius: 10px;
    background: rgba(255,196,74,0.08); color: var(--gold); font-family: inherit;
    font-size: 14px; font-weight: 700; cursor: pointer;
  }
  .record-btn:active { background: rgba(255,196,74,0.2); }
  .fps-input {
    width: 72px; padding: 10px 8px; border-radius: 10px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text); font-family: 'JetBrains Mono', monospace;
    font-size: 14px; font-weight: 600; outline: none; text-align: center;
    -moz-appearance: textfield;
  }
  .fps-input::-webkit-inner-spin-button,
  .fps-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  .fps-input:focus { border-color: var(--blue-dim); }
  .fps-label { font-size: 13px; color: var(--text2); font-weight: 500; }
  .fps-hint {
    background: rgba(255,196,74,0.08); border: 1px solid rgba(255,196,74,0.15); border-radius: 10px;
    padding: 8px 12px; margin-bottom: 12px; font-size: 11px; color: var(--gold); line-height: 1.5;
  }
  .fps-hint strong { color: #fff; }
  .fps-presets {
    display: flex; gap: 8px; margin-bottom: 12px; justify-content: center;
  }
  .preset-btn {
    padding: 8px 18px; border: 1px solid var(--gold-dim); border-radius: 8px;
    background: rgba(255,196,74,0.08); color: var(--gold); font-family: 'JetBrains Mono', monospace;
    font-size: 14px; font-weight: 600; cursor: pointer;
  }
  .preset-btn:active { background: rgba(255,196,74,0.2); }

  .slo-mo-tip {
    background: rgba(255,196,74,0.1); border: 1px solid var(--gold-dim); border-radius: 10px;
    padding: 10px 36px 10px 12px; margin-bottom: 12px; font-size: 12px; color: var(--gold);
    line-height: 1.5; position: relative;
  }
  .tip-dismiss { position: absolute; top: 6px; right: 10px; font-size: 18px; cursor: pointer; opacity: 0.6; padding: 4px; }

  .empty { text-align: center; padding: 48px 20px; color: var(--text3); }
  .empty-icon { font-size: 40px; margin-bottom: 10px; }
  .empty-text { font-size: 14px; line-height: 1.5; }

  .jump-item {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 14px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
  }
  .jump-height { font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 700; color: #fff; }
  .jump-height .unit { font-size: 14px; color: var(--text2); }
  .jump-meta { font-size: 11px; color: var(--text3); margin-top: 3px; font-family: 'JetBrains Mono', monospace; }
  .jump-label { font-size: 12px; color: var(--text2); margin-top: 2px; }
  .delete-btn { background: none; border: none; color: var(--text3); font-size: 22px; cursor: pointer; padding: 8px; line-height: 1; }
  .delete-btn:active { color: var(--red); }

  .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .log-header h3 { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); }
  .clear-all-btn { background: none; border: none; color: var(--text3); font-size: 11px; cursor: pointer; text-decoration: underline; font-family: inherit; }

  .chart-wrap { position: relative; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .chart-wrap canvas { display: block; }

  .legend { display: flex; justify-content: center; gap: 16px; margin-top: 10px; flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text2); }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
  .legend-line { width: 16px; height: 2px; border-radius: 1px; }

  .day-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .day-row:last-child { border-bottom: none; }
  .day-date { color: var(--text2); }
  .day-stats { font-family: 'JetBrains Mono', monospace; font-size: 12px; text-align: right; }
  .day-best { color: var(--gold); }
  .day-avg { color: var(--blue); }
  .day-count { color: var(--text3); }
  .day-sep { color: var(--text3); margin: 0 4px; }

  #fileInput { display: none; }
  button, input, select { touch-action: manipulation; }

  .toast {
    position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: var(--green); color: #000; padding: 10px 24px; border-radius: 24px;
    font-size: 14px; font-weight: 700; opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 100;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  .meta-debug {
    font-size: 0.65rem; color: var(--text3); background: rgba(0,0,0,0.3);
    padding: 8px; border-radius: 6px; margin-top: 6px; white-space: pre-wrap;
    word-break: break-all; line-height: 1.4; font-family: 'SF Mono', monospace;
  }

  .loading-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(10,14,26,0.85); display: flex; align-items: center; justify-content: center;
    z-index: 200; flex-direction: column; gap: 12px;
  }
  .loading-overlay .spinner {
    width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--blue);
    border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-overlay .loading-text { font-size: 14px; color: var(--text2); }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <h1>ü¶ò Jump Analyzer</h1>
    <span class="badge" id="badgeLabel">240 FPS</span>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="analyze" onclick="switchTab('analyze')">Analyze</button>
    <button class="tab" data-tab="log" onclick="switchTab('log')">Log <span class="count" id="logCount" style="display:none"></span></button>
    <button class="tab" data-tab="trends" onclick="switchTab('trends')">Trends</button>
  </div>

  <div id="tab-analyze">
    <div class="load-row">
      <button class="load-btn" onclick="document.getElementById('fileInput').click()">Load Video</button>
      <button class="record-btn" onclick="openCamera()">üì∑ Record</button>
      <input type="file" id="fileInput" accept="video/*" onchange="handleFile(event)">
      <span class="fps-label">Capture FPS:</span>
      <input type="number" class="fps-input" id="fpsInput" value="240" step="0.01" min="1" max="1000" onchange="changeFps()" onblur="changeFps()">
    </div>
    <div class="fps-hint" id="fpsHint">
      üí° Check actual FPS in <strong>Photos ‚Üí ‚ìò</strong> ‚Äî iPhones often capture below 240fps in lower light.
    </div>
    <div class="fps-presets" id="fpsPresets" style="display:none">
      <button class="preset-btn" onclick="setFpsPreset(120)">120</button>
      <button class="preset-btn" onclick="setFpsPreset(180)">180</button>
      <button class="preset-btn" onclick="setFpsPreset(240)">240</button>
      <button class="preset-btn" onclick="setFpsPreset(480)">480</button>
    </div>
    <div class="slo-mo-tip" id="sloMoTip" style="display:none">
      <span class="tip-dismiss" onclick="dismissTip()">√ó</span>
      üì± Open your <strong>Camera app</strong> ‚Üí swipe to <strong>SLO-MO</strong> ‚Üí record your jump ‚Üí come back here ‚Üí tap <strong>Load Video</strong> to analyze.
    </div>

    <div id="videoArea" style="display:none">
      <div class="video-box" id="videoBox">
        <video id="video" playsinline webkit-playsinline muted preload="auto"></video>
      </div>
      <div class="zoom-controls">
        <button class="zoom-btn active" onclick="setZoom(1)">1√ó</button>
        <button class="zoom-btn" onclick="setZoom(2)">2√ó</button>
        <button class="zoom-btn" onclick="setZoom(3)">3√ó</button>
        <button class="zoom-btn" onclick="setZoom(4)">4√ó</button>
        <button class="zoom-btn" onclick="resetPan()">Reset</button>
      </div>

      <div id="detectInfo" class="detect-info" style="display:none"></div>

      <div class="card">
        <div class="frame-display">
          <div class="frame-num" id="frameNum">0</div>
          <div class="frame-total">of <span id="totalFrames">0</span> frames</div>
          <div class="frame-time" id="frameTime">0.0000s real time</div>
        </div>

        <div class="scrubber-wrap" id="scrubberWrap">
          <input type="range" class="scrubber" id="scrubber" min="0" max="0" value="0" oninput="seekToFrame(Number(this.value))">
        </div>

        <div class="step-row">
          <button class="step-btn" onclick="stepFrame(-10)">‚àí10</button>
          <button class="step-btn" onclick="stepFrame(-1)">‚àí1</button>
          <button class="step-btn" onclick="stepFrame(1)">+1</button>
          <button class="step-btn" onclick="stepFrame(10)">+10</button>
        </div>

        <div class="card-title" style="margin-top:4px">Air Time</div>
        <div class="mark-row">
          <button class="mark-btn takeoff" id="takeoffBtn" onclick="markTakeoff()">
            ‚ñ≤ TAKEOFF
            <span class="mark-frame" id="takeoffLabel"></span>
          </button>
          <button class="mark-btn landing" id="landingBtn" onclick="markLanding()">
            ‚ñº LANDING
            <span class="mark-frame" id="landingLabel"></span>
          </button>
        </div>

        <div class="card-title" style="margin-top:8px">Ground Contact <span style="font-size:9px;opacity:0.5;text-transform:none;letter-spacing:0">(optional)</span></div>
        <div class="mark-row">
          <button class="mark-btn contact-in" id="contactInBtn" onclick="markContactIn()">
            ‚¨á CONTACT IN
            <span class="mark-frame" id="contactInLabel"></span>
          </button>
          <button class="mark-btn contact-out" id="contactOutBtn" onclick="markContactOut()">
            ‚¨Ü CONTACT OUT
            <span class="mark-frame" id="contactOutLabel"></span>
          </button>
        </div>
        <button class="clear-link" id="clearMarks" style="display:none" onclick="clearMarks()">Clear marks</button>
      </div>

      <div class="results" id="resultsCard" style="display:none">
        <div class="results-title">üìê Results</div>
        <div class="stats-grid">
          <div class="stat wide">
            <div class="stat-value highlight" id="resultHeight">‚Äî</div>
            <div class="stat-label">Vertical (inches)</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="resultHeightCm">‚Äî</div>
            <div class="stat-label">CM</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="resultAirTime">‚Äî</div>
            <div class="stat-label">Air Time</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="resultFrames">‚Äî</div>
            <div class="stat-label">Real Frames</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="resultFps">‚Äî</div>
            <div class="stat-label">Capture FPS</div>
          </div>
        </div>
        <div id="gctSection" style="display:none">
          <div style="height:1px;background:var(--border);margin:8px 0 12px"></div>
          <div class="stats-grid">
            <div class="stat">
              <div class="stat-value" id="resultGCT" style="color:#ffa500">‚Äî</div>
              <div class="stat-label">Ground Contact</div>
            </div>
            <div class="stat">
              <div class="stat-value" id="resultRSI" style="color:#c882ff">‚Äî</div>
              <div class="stat-label">RSI</div>
            </div>
          </div>
        </div>
        <div class="log-form">
          <input type="text" class="log-input" id="labelInput" placeholder="Label (optional)">
          <button class="log-btn" onclick="logJump()">Save</button>
        </div>
      </div>
    </div>

    <div id="emptyAnalyze" class="empty">
      <div class="empty-icon">üé¨</div>
      <div class="empty-text">Load a slo-mo video to<br>measure your vertical</div>
      <div style="margin-top:16px;font-size:11px;color:var(--text3);line-height:1.6">
        Record in <strong style="color:var(--text2)">Camera ‚Üí Slo-Mo</strong> mode<br>
        then come back and tap <strong style="color:var(--text2)">Load Video</strong>
      </div>
    </div>
  </div>

  <div id="tab-log" style="display:none"><div id="logContent"></div></div>
  <div id="tab-trends" style="display:none"><div id="trendsContent"></div></div>
</div>

<div class="toast" id="toast"></div>

<script>
// ======== MP4 METADATA PARSER ========
// Parses the MP4 container to extract frame count and timing info
function parseMP4ForFps(file) {
  return new Promise(function(resolve) {
    // Strategy: First scan top-level box headers to find moov location,
    // then do a targeted read of just the moov box.
    // iPhone slo-mo files can be 500MB+ with moov at the END.

    var HEADER_SCAN_SIZE = 64 * 1024; // 64KB to scan top-level boxes
    var MAX_MOOV_READ = 50 * 1024 * 1024; // 50MB max moov read

    function processBuffer(buffer) {
      try {
        var dv = new DataView(buffer);
        var result = findVideoTrackInfo(dv, 0, dv.byteLength);
        if (result && result.timescale && result.sampleDurations.length > 0) {
          var totalSamples = 0;
          var totalTicks = 0;
          result.sampleDurations.forEach(function(entry) {
            totalSamples += entry.count;
            totalTicks += entry.count * entry.duration;
          });
          var mediaDurationSec = totalTicks / result.timescale;
          var naiveFps = result.timescale / result.sampleDurations[0].duration;
          var isTimescaleArtifact = (
            Math.abs(naiveFps - result.timescale) < 1 ||
            result.timescale === 600 ||
            result.timescale === 6000 ||
            result.timescale === 60000
          );
          return {
            totalSamples: totalSamples,
            totalTicks: totalTicks,
            timescale: result.timescale,
            mediaDurationSec: mediaDurationSec,
            naiveFps: naiveFps,
            isTimescaleArtifact: isTimescaleArtifact,
            sampleDurations: result.sampleDurations
          };
        }
      } catch(e) {}
      return null;
    }

    function scanTopLevelBoxes(dv) {
      // Scan top-level box headers to find moov offset and size
      var pos = 0;
      var boxes = [];
      while (pos < dv.byteLength - 8) {
        var size = dv.getUint32(pos);
        var type = '';
        try {
          type = String.fromCharCode(dv.getUint8(pos+4), dv.getUint8(pos+5), dv.getUint8(pos+6), dv.getUint8(pos+7));
        } catch(e) { break; }

        if (size < 8) break;

        // Handle 64-bit extended size
        var realSize = size;
        if (size === 1 && pos + 16 <= dv.byteLength) {
          // 64-bit size: read as two 32-bit ints
          var hi = dv.getUint32(pos + 8);
          var lo = dv.getUint32(pos + 12);
          realSize = hi * 4294967296 + lo;
        }

        boxes.push({ type: type, offset: pos, size: realSize });
        if (type === 'moov') return { found: true, offset: pos, size: realSize, boxes: boxes };
        pos += realSize;
      }
      return { found: false, boxes: boxes };
    }

    // Step 1: Read beginning to scan box headers
    var headerSlice = file.slice(0, Math.min(file.size, HEADER_SCAN_SIZE));
    var headerReader = new FileReader();
    headerReader.onload = function(e) {
      var headerDv = new DataView(e.target.result);
      var scan = scanTopLevelBoxes(headerDv);

      if (scan.found) {
        // moov is near the start ‚Äî read it directly
        var moovEnd = Math.min(scan.offset + scan.size, file.size);
        var readSize = Math.min(scan.size, MAX_MOOV_READ);
        var moovSlice = file.slice(scan.offset, scan.offset + readSize);
        var moovReader = new FileReader();
        moovReader.onload = function(e2) {
          // We need to wrap moov in a buffer that findVideoTrackInfo can parse
          // It expects to find 'moov' box, so we read from moov start
          resolve(processBuffer(e2.target.result));
        };
        moovReader.onerror = function() { resolve(null); };
        moovReader.readAsArrayBuffer(moovSlice);
      } else {
        // moov not in first 64KB ‚Äî likely at end of file (iPhone recording)
        // Calculate how much of the end to read
        // Use the box scan to estimate: total file size minus known box sizes
        var knownEnd = 0;
        scan.boxes.forEach(function(b) { knownEnd = Math.max(knownEnd, b.offset + b.size); });

        // If we could determine total size of preceding boxes, moov starts there
        // Otherwise read the last chunk generously
        var tailSize = Math.min(file.size, MAX_MOOV_READ);
        if (knownEnd > 0 && knownEnd < file.size) {
          // We know where preceding boxes end, so moov starts around there
          tailSize = Math.min(file.size - knownEnd + 1024, MAX_MOOV_READ);
        }

        var tailStart = Math.max(0, file.size - tailSize);
        var tailSlice = file.slice(tailStart, file.size);
        var tailReader = new FileReader();
        tailReader.onload = function(e2) {
          var result = processBuffer(e2.target.result);
          if (result) {
            resolve(result);
          } else {
            // Last resort: try reading more from the end
            if (tailSize < file.size && tailSize < MAX_MOOV_READ) {
              var bigSlice = file.slice(0, Math.min(file.size, MAX_MOOV_READ));
              var bigReader = new FileReader();
              bigReader.onload = function(e3) { resolve(processBuffer(e3.target.result)); };
              bigReader.onerror = function() { resolve(null); };
              bigReader.readAsArrayBuffer(bigSlice);
            } else {
              resolve(null);
            }
          }
        };
        tailReader.onerror = function() { resolve(null); };
        tailReader.readAsArrayBuffer(tailSlice);
      }
    };
    headerReader.onerror = function() { resolve(null); };
    headerReader.readAsArrayBuffer(headerSlice);
  });
}

function findVideoTrackInfo(dv, start, end) {
  // Find moov box, then navigate to video track's mdhd and stts
  var moov = findBox(dv, start, end, 'moov');
  if (!moov) return null;

  // Find all trak boxes inside moov
  var offset = moov.dataStart;
  while (offset < moov.end) {
    var trak = findBox(dv, offset, moov.end, 'trak');
    if (!trak) break;

    // Check if this is a video track by looking for 'vmhd' (video media header) inside mdia>minf
    var mdia = findBox(dv, trak.dataStart, trak.end, 'mdia');
    if (mdia) {
      var minf = findBox(dv, mdia.dataStart, mdia.end, 'minf');
      if (minf) {
        var vmhd = findBox(dv, minf.dataStart, minf.end, 'vmhd');
        if (vmhd) {
          // This is the video track! Get timescale from mdhd and durations from stts
          var mdhd = findBox(dv, mdia.dataStart, mdia.end, 'mdhd');
          var stbl = findBox(dv, minf.dataStart, minf.end, 'stbl');

          if (mdhd && stbl) {
            var timescale = parseMdhd(dv, mdhd);
            var stts = findBox(dv, stbl.dataStart, stbl.end, 'stts');
            if (stts && timescale) {
              var durations = parseStts(dv, stts);
              return { timescale: timescale, sampleDurations: durations };
            }
          }
        }
      }
    }
    offset = trak.end;
  }
  return null;
}

function findBox(dv, start, end, type) {
  var pos = start;
  var target = boxTypeToInt(type);
  while (pos < end - 8) {
    var size = dv.getUint32(pos);
    var btype = dv.getUint32(pos + 4);
    if (size < 8) break; // Invalid
    if (size === 1 && pos + 16 <= end) {
      // 64-bit extended size ‚Äî skip for simplicity
      break;
    }
    if (btype === target) {
      return { dataStart: pos + 8, end: pos + size, size: size };
    }
    pos += size;
  }
  return null;
}

function boxTypeToInt(s) {
  return (s.charCodeAt(0) << 24) | (s.charCodeAt(1) << 16) | (s.charCodeAt(2) << 8) | s.charCodeAt(3);
}

function parseMdhd(dv, box) {
  // mdhd is a full box: version(1) + flags(3) + ...
  var pos = box.dataStart;
  var version = dv.getUint8(pos);
  if (version === 0) {
    // version 0: creation(4) + modification(4) + timescale(4) + duration(4)
    return dv.getUint32(pos + 12);
  } else if (version === 1) {
    // version 1: creation(8) + modification(8) + timescale(4) + duration(8)
    return dv.getUint32(pos + 20);
  }
  return null;
}

function parseStts(dv, box) {
  // stts: version(1) + flags(3) + entry_count(4) + entries(8 each: count + duration)
  var pos = box.dataStart;
  var entryCount = dv.getUint32(pos + 4);
  var entries = [];
  var ePos = pos + 8;
  for (var i = 0; i < entryCount && ePos + 8 <= box.end; i++) {
    entries.push({
      count: dv.getUint32(ePos),
      duration: dv.getUint32(ePos + 4)
    });
    ePos += 8;
  }
  return entries;
}

// ======== STATE ========
var GRAVITY_IN = 386.0886;
var captureFps = 240;
var detectedPlaybackFps = null;
var mp4TotalSamples = null;
var frameInterval = 1/30;
var currentFrame = 0;
var totalFrames = 0;
var duration = 0;
var takeoffFrame = null;
var landingFrame = null;
var contactInFrame = null;
var contactOutFrame = null;
var jumps = [];
var videoLoaded = false;

var video = document.getElementById('video');
var scrubber = document.getElementById('scrubber');

// ======== STORAGE ========
function loadJumps() {
  try { var d = localStorage.getItem('jump-analyzer-log'); if (d) jumps = JSON.parse(d); } catch(e) {}
  updateLogCount();
}
function saveJumps() {
  try { localStorage.setItem('jump-analyzer-log', JSON.stringify(jumps)); } catch(e) {}
  updateLogCount();
}
function updateLogCount() {
  var el = document.getElementById('logCount');
  if (jumps.length > 0) { el.textContent = jumps.length; el.style.display = 'inline'; }
  else { el.style.display = 'none'; }
}

// ======== FRAME RATE DETECTION ========
function detectFrameRate(vid) {
  return new Promise(function(resolve) {
    if ('requestVideoFrameCallback' in HTMLVideoElement.prototype) {
      var frameTimes = [];
      var count = 0;
      var maxSamples = 24;
      var done = false;

      function onFrame(now, metadata) {
        if (done) return;
        frameTimes.push(metadata.mediaTime);
        count++;
        if (count < maxSamples) {
          vid.requestVideoFrameCallback(onFrame);
        } else {
          done = true;
          vid.pause();
          // Calculate intervals between frames
          var intervals = [];
          for (var i = 1; i < frameTimes.length; i++) {
            var diff = frameTimes[i] - frameTimes[i - 1];
            if (diff > 0.0001) intervals.push(diff);
          }
          if (intervals.length > 2) {
            intervals.sort(function(a, b) { return a - b; });
            // Use median to be robust against outliers
            var median = intervals[Math.floor(intervals.length / 2)];
            var detFps = Math.round(1 / median);
            resolve({ fps: detFps, interval: median });
          } else {
            resolve(null);
          }
        }
      }

      vid.currentTime = 0.5;
      vid.play().then(function() {
        vid.requestVideoFrameCallback(onFrame);
      }).catch(function() { resolve(null); });

      setTimeout(function() {
        if (!done) { done = true; vid.pause(); resolve(null); }
      }, 5000);
    } else {
      resolve(null);
    }
  });
}

function showLoading(msg) {
  var overlay = document.createElement('div');
  overlay.className = 'loading-overlay';
  overlay.id = 'loadingOverlay';
  overlay.innerHTML = '<div class="spinner"></div><div class="loading-text">' + msg + '</div>';
  document.body.appendChild(overlay);
}
function hideLoading() {
  var el = document.getElementById('loadingOverlay');
  if (el) el.remove();
}

// ======== VIDEO LOADING ========
function handleFile(e) {
  var file = e.target.files[0];
  if (!file) return;
  var url = URL.createObjectURL(file);
  video.src = url;
  video.load();

  video.onloadedmetadata = function() {
    duration = video.duration;
    videoLoaded = false;
    var sizeMB = (file.size / (1024*1024)).toFixed(0);
    showLoading('Analyzing video' + (sizeMB > 50 ? ' (' + sizeMB + ' MB ‚Äî finding metadata...)' : '...'));

    // Step 1: Extract frame info from MP4 metadata
    parseMP4ForFps(file).then(function(mp4Info) {
      var hintEl = document.getElementById('fpsHint');
      var presetsEl = document.getElementById('fpsPresets');
      presetsEl.style.display = 'none';

      if (mp4Info && mp4Info.totalSamples > 0) {
        // ---- SMART FPS DETECTION FROM STTS ENTRIES ----
        // The stts box tells us exactly how long each frame is in timescale units.
        // Multiple entries with different durations = variable frame rate (VFR)
        // e.g., iPhone slo-mo with normal-speed bookends

        var avgFps = mp4Info.totalSamples / duration;
        avgFps = Math.round(avgFps * 100) / 100;
        var ts = mp4Info.timescale;
        var entries = mp4Info.sampleDurations;

        // Compute fps for each stts entry
        var entryRates = entries.map(function(e) {
          return {
            count: e.count,
            duration: e.duration,
            fps: Math.round((ts / e.duration) * 100) / 100
          };
        });

        // Check for constant vs variable frame rate
        var uniqueDurations = [];
        entries.forEach(function(e) {
          if (uniqueDurations.indexOf(e.duration) === -1) uniqueDurations.push(e.duration);
        });
        var isVFR = uniqueDurations.length > 1;

        // Group entries by similar fps (within 15% of each other) to handle encoder jitter
        // e.g., dur=19 (31.58fps) and dur=20 (30fps) are the same rate ‚Äî just jitter
        var groups = []; // { fps: weighted avg, totalFrames: N, entries: [...] }
        entryRates.forEach(function(e) {
          var matched = false;
          for (var g = 0; g < groups.length; g++) {
            var ratio = e.fps / groups[g].fps;
            if (ratio > 0.85 && ratio < 1.15) {
              // Same group ‚Äî update weighted average
              var oldTotal = groups[g].totalFrames;
              groups[g].totalFrames += e.count;
              groups[g].fps = (groups[g].fps * oldTotal + e.fps * e.count) / groups[g].totalFrames;
              groups[g].entries.push(e);
              matched = true;
              break;
            }
          }
          if (!matched) {
            groups.push({ fps: e.fps, totalFrames: e.count, entries: [e] });
          }
        });

        // Sort groups by fps descending
        groups.sort(function(a, b) { return b.fps - a.fps; });

        // Find slo-mo group: highest fps group with substantial frame count
        // Ignore groups with < 10 frames (jitter artifacts)
        var sloMoGroup = null;
        var normalGroup = null;
        for (var g = 0; g < groups.length; g++) {
          if (groups[g].totalFrames >= 10) {
            if (!sloMoGroup) sloMoGroup = groups[g];
            else if (!normalGroup) normalGroup = groups[g];
          }
        }

        // If slo-mo and normal groups exist and are significantly different (2x+), it's real VFR
        var hasRealSloMo = sloMoGroup && normalGroup && (sloMoGroup.fps / normalGroup.fps > 1.8);
        var sloMoFps = sloMoGroup ? Math.round(sloMoGroup.fps * 100) / 100 : avgFps;
        var sloMoFrameCount = sloMoGroup ? sloMoGroup.totalFrames : mp4Info.totalSamples;

        // Filter out timescale artifacts: if the computed fps equals the timescale,
        // all durations are 1 and it's a timescale encoding, not real fps
        var isArtifact = (
          sloMoFps > 500 && Math.abs(sloMoFps - ts) < 2
        ) || (ts === 600 && sloMoFps > 500);

        // Build metadata debug string
        var metaLines = ['Timescale: ' + ts];
        entryRates.forEach(function(e, i) {
          metaLines.push('Entry ' + (i+1) + ': ' + e.count + ' frames @ ' + e.fps + ' fps (dur=' + e.duration + ')');
        });
        if (entryRates.length > 20) {
          metaLines = ['Timescale: ' + ts, '(' + entryRates.length + ' stts entries ‚Äî showing groups)'];
        }
        metaLines.push('---');
        groups.forEach(function(g, i) {
          metaLines.push('Group ' + (i+1) + ': ~' + Math.round(g.fps) + ' fps (' + g.totalFrames + ' frames)');
        });
        metaLines.push('---');
        metaLines.push('Total: ' + mp4Info.totalSamples + ' frames, avg ' + avgFps + ' fps');
        metaLines.push('Duration: ' + duration.toFixed(4) + 's');
        metaLines.push(isVFR ? 'Variable frame rate (VFR)' : 'Constant frame rate (CFR)');
        if (hasRealSloMo) metaLines.push('Slo-mo section: ~' + Math.round(sloMoFps) + ' fps (' + sloMoFrameCount + ' frames)');
        var metaDebug = metaLines.join('\n');

        var detectedFps = null;
        var confidence = '';

        if (isArtifact) {
          // Timescale artifact ‚Äî fall back to avgFps
          detectedFps = avgFps;
          confidence = 'avg';
        } else if (!isVFR || !hasRealSloMo) {
          // Constant frame rate, or VFR but just jitter (no real slo-mo section)
          // Use the dominant rate
          detectedFps = sloMoFps;
          confidence = hasRealSloMo ? 'vfr-slomo' : 'exact';
        } else {
          // Real VFR with distinct slo-mo section
          detectedFps = sloMoFps;
          confidence = 'vfr-slomo';
        }

        // Round to nearest 0.01
        detectedFps = Math.round(detectedFps * 100) / 100;

        captureFps = detectedFps;
        document.getElementById('fpsInput').value = captureFps;
        document.getElementById('badgeLabel').textContent = captureFps + ' FPS';

        if (confidence === 'exact') {
          hintEl.innerHTML = '\u2705 Detected <strong>' + captureFps + ' fps</strong> capture rate (constant). <a href="#" onclick="toggleMeta(event)" style="color:var(--text3);font-size:0.75rem">details</a><pre class="meta-debug" id="metaDebug" style="display:none">' + metaDebug + '</pre>';
          hintEl.style.borderColor = 'rgba(45,216,129,0.2)';
          hintEl.style.background = 'rgba(45,216,129,0.08)';
          hintEl.style.color = 'var(--green)';
        } else if (confidence === 'vfr-slomo') {
          hintEl.innerHTML = '\u2705 Variable rate file ‚Äî slo-mo section: <strong>' + sloMoFps + ' fps</strong> (' + sloMoFrameCount + ' frames). Bookend sections at different rate. <a href="#" onclick="toggleMeta(event)" style="color:var(--text3);font-size:0.75rem">details</a><pre class="meta-debug" id="metaDebug" style="display:none">' + metaDebug + '</pre>';
          hintEl.style.borderColor = 'rgba(45,216,129,0.2)';
          hintEl.style.background = 'rgba(45,216,129,0.08)';
          hintEl.style.color = 'var(--green)';
        } else {
          // Artifact fallback ‚Äî use avgFps but warn
          hintEl.innerHTML = '\u26A0\uFE0F Timescale artifact detected (ts=' + ts + '). Using average: <strong>' + captureFps + ' fps</strong>. Verify and adjust if needed. <a href="#" onclick="toggleMeta(event)" style="color:var(--text3);font-size:0.75rem">details</a><pre class="meta-debug" id="metaDebug" style="display:none">' + metaDebug + '</pre>';
          hintEl.style.borderColor = 'rgba(255,196,74,0.15)';
          hintEl.style.background = 'rgba(255,196,74,0.08)';
          hintEl.style.color = 'var(--gold)';
          presetsEl.style.display = 'flex';
        }
      } else {
        hintEl.innerHTML = '\u26A0\uFE0F Could not read metadata. Check <strong>Photos \u2192 \u24D8</strong> for FPS and enter it above.';
        hintEl.style.borderColor = 'rgba(255,196,74,0.15)';
        hintEl.style.background = 'rgba(255,196,74,0.08)';
        hintEl.style.color = 'var(--gold)';
        presetsEl.style.display = 'flex';
      }

      // Step 2: Determine total frames for stepping
      // Use MP4 frame count as ground truth when available ‚Äî it's always accurate
      // Only fall back to requestVideoFrameCallback if MP4 parsing failed
      var useMP4Frames = (mp4Info && mp4Info.totalSamples > 10);

      if (useMP4Frames) {
        mp4TotalSamples = mp4Info.totalSamples;
        totalFrames = mp4TotalSamples;
        frameInterval = duration / totalFrames;
        detectedPlaybackFps = Math.round(1 / frameInterval);
        finishVideoSetup();
      } else {
        // Fallback: detect playback rate
        detectFrameRate(video).then(function(detected) {
          if (detected && detected.fps > 0) {
            detectedPlaybackFps = detected.fps;
            frameInterval = detected.interval;
          } else {
            detectedPlaybackFps = 30;
            frameInterval = 1 / 30;
          }
          totalFrames = Math.round(duration / frameInterval);
          mp4TotalSamples = null;
          finishVideoSetup();
        });
      }
    });
  };
}

function finishVideoSetup() {
  scrubber.max = totalFrames;
  scrubber.value = 0;
  currentFrame = 0;
  video.currentTime = 0;
  video.pause();
  videoLoaded = true;
  takeoffFrame = null;
  landingFrame = null;
  contactInFrame = null;
  contactOutFrame = null;
  clearResults();
  updateFrameDisplay();
  updateMarkerUI();

  document.getElementById('videoArea').style.display = 'block';
  document.getElementById('emptyAnalyze').style.display = 'none';
  document.getElementById('totalFrames').textContent = totalFrames;

  // Show detection info
  var infoEl = document.getElementById('detectInfo');
  if (mp4TotalSamples) {
    infoEl.innerHTML = '<strong>' + totalFrames + '</strong> frames from file ¬∑ Each step = 1 captured frame';
  } else {
    var slowdown = captureFps / detectedPlaybackFps;
    if (Math.abs(slowdown - 1) < 0.2) {
      infoEl.innerHTML = 'Video plays at <strong>' + detectedPlaybackFps + 'fps</strong> (real time). Each frame = 1 real frame.';
    } else {
      infoEl.innerHTML = 'Detected <strong>' + detectedPlaybackFps + 'fps</strong> playback \u00B7 <strong>' + slowdown.toFixed(1) + '\u00D7 slow motion</strong> \u00B7 Each step = 1 unique frame';
    }
  }
  infoEl.style.display = 'block';
  document.getElementById('badgeLabel').textContent = captureFps + ' FPS';

  hideLoading();
}

function setFpsPreset(val) {
  document.getElementById('fpsInput').value = val;
  changeFps();
}

function changeFps() {
  var val = parseFloat(document.getElementById('fpsInput').value);
  if (!val || val <= 0) return;
  captureFps = val;
  document.getElementById('badgeLabel').textContent = captureFps + ' FPS';
  document.getElementById('fpsPresets').style.display = 'none';
  if (videoLoaded) {
    takeoffFrame = null;
    landingFrame = null;
    contactInFrame = null;
    contactOutFrame = null;
    clearResults();
    updateMarkerUI();
    updateFrameDisplay();
  }
}

function toggleMeta(e) {
  e.preventDefault();
  var el = document.getElementById('metaDebug');
  if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

// ======== FRAME NAVIGATION ========
function seekToFrame(frame) {
  if (!videoLoaded) return;
  frame = Math.max(0, Math.min(frame, totalFrames));
  currentFrame = frame;
  video.currentTime = frame * frameInterval;
  video.pause();
  scrubber.value = frame;
  updateFrameDisplay();
  autoCalc();
}

function stepFrame(delta) {
  seekToFrame(currentFrame + delta);
}

function updateFrameDisplay() {
  document.getElementById('frameNum').textContent = currentFrame;
  // Real time: each frame = 1/captureFps in real world
  var realTime = currentFrame / captureFps;
  document.getElementById('frameTime').textContent = realTime.toFixed(4) + 's real time';
}

// ======== MARKS ========
function markTakeoff() { takeoffFrame = currentFrame; updateMarkerUI(); autoCalc(); }
function markLanding() { landingFrame = currentFrame; updateMarkerUI(); autoCalc(); }
function markContactIn() { contactInFrame = currentFrame; updateMarkerUI(); autoCalc(); }
function markContactOut() { contactOutFrame = currentFrame; updateMarkerUI(); autoCalc(); }
function clearMarks() {
  takeoffFrame = null; landingFrame = null;
  contactInFrame = null; contactOutFrame = null;
  updateMarkerUI(); clearResults();
}

function updateMarkerUI() {
  var tbtn = document.getElementById('takeoffBtn');
  var lbtn = document.getElementById('landingBtn');
  var cibtn = document.getElementById('contactInBtn');
  var cobtn = document.getElementById('contactOutBtn');
  var tlabel = document.getElementById('takeoffLabel');
  var llabel = document.getElementById('landingLabel');
  var cilabel = document.getElementById('contactInLabel');
  var colabel = document.getElementById('contactOutLabel');
  var clearEl = document.getElementById('clearMarks');

  if (takeoffFrame !== null) { tbtn.classList.add('set'); tlabel.textContent = 'Frame ' + takeoffFrame; }
  else { tbtn.classList.remove('set'); tlabel.textContent = ''; }
  if (landingFrame !== null) { lbtn.classList.add('set'); llabel.textContent = 'Frame ' + landingFrame; }
  else { lbtn.classList.remove('set'); llabel.textContent = ''; }
  if (contactInFrame !== null) { cibtn.classList.add('set'); cilabel.textContent = 'Frame ' + contactInFrame; }
  else { cibtn.classList.remove('set'); cilabel.textContent = ''; }
  if (contactOutFrame !== null) { cobtn.classList.add('set'); colabel.textContent = 'Frame ' + contactOutFrame; }
  else { cobtn.classList.remove('set'); colabel.textContent = ''; }

  var anyMarked = (takeoffFrame !== null || landingFrame !== null || contactInFrame !== null || contactOutFrame !== null);
  clearEl.style.display = anyMarked ? 'block' : 'none';

  document.querySelectorAll('.marker').forEach(function(m) { m.remove(); });
  var wrap = document.getElementById('scrubberWrap');
  var allMarkers = [
    { frame: contactInFrame, cls: 'contact-in' },
    { frame: takeoffFrame, cls: 'takeoff' },
    { frame: landingFrame, cls: 'landing' },
    { frame: contactOutFrame, cls: 'contact-out' }
  ];
  allMarkers.forEach(function(mk) {
    if (mk.frame !== null && totalFrames > 0) {
      var m = document.createElement('div');
      m.className = 'marker ' + mk.cls;
      m.style.left = (mk.frame / totalFrames * 100) + '%';
      wrap.appendChild(m);
    }
  });
}

// ======== CALCULATION ========
function autoCalc() {
  if (takeoffFrame !== null && landingFrame !== null && landingFrame > takeoffFrame) {
    var frameDiff = landingFrame - takeoffFrame;
    var realAirTime = frameDiff / captureFps;
    var halfT = realAirTime / 2;
    var heightIn = 0.5 * GRAVITY_IN * halfT * halfT;
    var heightCm = heightIn * 2.54;
    var heightM = heightCm / 100;

    // Ground contact time + RSI
    var gct = null;
    var rsi = null;
    if (contactInFrame !== null && contactOutFrame !== null && contactOutFrame > contactInFrame) {
      var gctFrames = contactOutFrame - contactInFrame;
      gct = gctFrames / captureFps;
      rsi = heightM / gct; // RSI = jump height (m) / ground contact time (s)
    }

    showResults(frameDiff, realAirTime, heightIn, heightCm, gct, rsi);
  } else {
    clearResults();
  }
}

function showResults(frames, airTime, heightIn, heightCm, gct, rsi) {
  document.getElementById('resultsCard').style.display = 'block';
  document.getElementById('resultHeight').textContent = heightIn.toFixed(1) + '\u2033';
  document.getElementById('resultHeightCm').textContent = heightCm.toFixed(1);
  document.getElementById('resultAirTime').textContent = airTime.toFixed(4) + 's';
  document.getElementById('resultFrames').textContent = frames;
  document.getElementById('resultFps').textContent = captureFps;

  var gctSection = document.getElementById('gctSection');
  if (gct !== null && rsi !== null) {
    gctSection.style.display = 'block';
    document.getElementById('resultGCT').textContent = (gct * 1000).toFixed(0) + 'ms';
    document.getElementById('resultRSI').textContent = rsi.toFixed(2);
  } else {
    gctSection.style.display = 'none';
  }
}

function clearResults() { document.getElementById('resultsCard').style.display = 'none'; }

// ======== LOG ========
function logJump() {
  if (takeoffFrame === null || landingFrame === null || landingFrame <= takeoffFrame) return;
  var frameDiff = landingFrame - takeoffFrame;
  var realAirTime = frameDiff / captureFps;
  var halfT = realAirTime / 2;
  var heightIn = 0.5 * GRAVITY_IN * halfT * halfT;
  var heightCm = heightIn * 2.54;
  var heightM = heightCm / 100;
  var label = document.getElementById('labelInput').value.trim();

  var gct = null;
  var rsi = null;
  if (contactInFrame !== null && contactOutFrame !== null && contactOutFrame > contactInFrame) {
    var gctFrames = contactOutFrame - contactInFrame;
    gct = gctFrames / captureFps;
    rsi = heightM / gct;
  }

  var entry = {
    id: Date.now().toString(),
    timestamp: new Date().toISOString(),
    fps: captureFps,
    playbackFps: detectedPlaybackFps,
    frames: frameDiff,
    airTime: realAirTime,
    heightIn: heightIn,
    heightCm: heightCm,
    gct: gct,
    rsi: rsi,
    label: label || undefined
  };

  jumps.unshift(entry);
  saveJumps();
  document.getElementById('labelInput').value = '';
  var msg = 'Jump logged \u2014 ' + heightIn.toFixed(1) + '\u2033';
  if (rsi !== null) msg += ' \u00B7 RSI ' + rsi.toFixed(2);
  showToast(msg);
}

function deleteJump(id) { jumps = jumps.filter(function(j) { return j.id !== id; }); saveJumps(); renderLog(); }
function clearAllJumps() { if (confirm('Delete all logged jumps?')) { jumps = []; saveJumps(); renderLog(); } }

// ======== TOAST ========
function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2000);
}

// ======== CAMERA ========
function openCamera() {
  document.getElementById('sloMoTip').style.display = 'block';
  document.getElementById('sloMoTip').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
function dismissTip() { document.getElementById('sloMoTip').style.display = 'none'; }

// ======== TABS ========
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelector('.tab[data-tab="' + tab + '"]').classList.add('active');
  document.getElementById('tab-analyze').style.display = tab === 'analyze' ? 'block' : 'none';
  document.getElementById('tab-log').style.display = tab === 'log' ? 'block' : 'none';
  document.getElementById('tab-trends').style.display = tab === 'trends' ? 'block' : 'none';
  if (tab === 'log') renderLog();
  if (tab === 'trends') renderTrends();
}

// ======== RENDER LOG ========
function renderLog() {
  var container = document.getElementById('logContent');
  if (jumps.length === 0) {
    container.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><div class="empty-text">No jumps logged yet.<br>Analyze a video and save your first jump!</div></div>';
    return;
  }
  var todayKey = new Date().toISOString().split('T')[0];
  var todayJumps = jumps.filter(function(j) { return j.timestamp.startsWith(todayKey); });
  var allAvg = jumps.reduce(function(s, j) { return s + j.heightIn; }, 0) / jumps.length;
  var allBest = Math.max.apply(null, jumps.map(function(j) { return j.heightIn; }));

  var html = '';
  if (todayJumps.length > 0) {
    var todayAvg = todayJumps.reduce(function(s, j) { return s + j.heightIn; }, 0) / todayJumps.length;
    var todayBest = Math.max.apply(null, todayJumps.map(function(j) { return j.heightIn; }));
    html += '<div class="card"><div class="card-title">Today</div><div class="stats-grid">';
    html += '<div class="stat"><div class="stat-value">' + todayJumps.length + '</div><div class="stat-label">Jumps</div></div>';
    html += '<div class="stat"><div class="stat-value highlight">' + todayBest.toFixed(1) + '\u2033</div><div class="stat-label">Best</div></div>';
    html += '<div class="stat"><div class="stat-value">' + todayAvg.toFixed(1) + '\u2033</div><div class="stat-label">Average</div></div>';
    html += '</div></div>';
  }

  html += '<div class="card"><div class="card-title">All Time</div><div class="stats-grid">';
  html += '<div class="stat"><div class="stat-value">' + jumps.length + '</div><div class="stat-label">Jumps</div></div>';
  html += '<div class="stat"><div class="stat-value highlight">' + allBest.toFixed(1) + '\u2033</div><div class="stat-label">Best</div></div>';
  html += '<div class="stat"><div class="stat-value">' + allAvg.toFixed(1) + '\u2033</div><div class="stat-label">Average</div></div>';
  html += '</div></div>';

  html += '<div class="log-header"><h3>History</h3><button class="clear-all-btn" onclick="clearAllJumps()">Clear all</button></div>';
  jumps.forEach(function(j) {
    var d = new Date(j.timestamp);
    var dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    var timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    html += '<div class="jump-item"><div>';
    html += '<div class="jump-height">' + j.heightIn.toFixed(1) + '<span class="unit">\u2033</span> <span style="font-size:13px;color:var(--text3);font-weight:400">' + j.heightCm.toFixed(1) + ' cm</span></div>';
    html += '<div class="jump-meta">' + dateStr + ' ' + timeStr + ' \u00B7 ' + j.airTime.toFixed(4) + 's \u00B7 ' + j.frames + 'f@' + j.fps;
    if (j.gct) html += ' \u00B7 GCT ' + (j.gct * 1000).toFixed(0) + 'ms';
    if (j.rsi) html += ' \u00B7 RSI ' + j.rsi.toFixed(2);
    html += '</div>';
    if (j.label) html += '<div class="jump-label">' + escapeHtml(j.label) + '</div>';
    html += '</div><button class="delete-btn" onclick="deleteJump(\'' + j.id + '\')">√ó</button></div>';
  });
  container.innerHTML = html;
}

function escapeHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// ======== RENDER TRENDS ========
function renderTrends() {
  var container = document.getElementById('trendsContent');
  var days = {};
  jumps.forEach(function(j) { var key = j.timestamp.split('T')[0]; if (!days[key]) days[key] = []; days[key].push(j); });
  var sortedDays = Object.keys(days).sort();

  if (sortedDays.length < 2) {
    container.innerHTML = '<div class="empty"><div class="empty-icon">üìà</div><div class="empty-text">Log jumps across 2+ days<br>to see your trends.</div></div>';
    return;
  }

  var dailyData = sortedDays.map(function(day) {
    var dj = days[day];
    var avg = dj.reduce(function(s, j) { return s + j.heightIn; }, 0) / dj.length;
    var best = Math.max.apply(null, dj.map(function(j) { return j.heightIn; }));
    return { day: day, avg: avg, best: best, count: dj.length };
  });

  var trendData = dailyData.map(function(d, i) {
    var w = dailyData.slice(Math.max(0, i - 6), i + 1);
    var rolling = w.reduce(function(s, x) { return s + x.avg; }, 0) / w.length;
    return { day: d.day, avg: d.avg, best: d.best, count: d.count, rolling7: rolling };
  });

  var html = '<div class="card"><div class="card-title">Daily Best & Average (inches)</div>';
  html += '<div class="chart-wrap"><canvas id="trendChart"></canvas></div>';
  html += '<div class="legend">';
  html += '<div class="legend-item"><div class="legend-dot" style="background:var(--gold)"></div> Daily Best</div>';
  html += '<div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div> Daily Avg</div>';
  html += '<div class="legend-item"><div class="legend-line" style="background:var(--green)"></div> 7-Day Rolling</div>';
  html += '</div></div>';

  html += '<div class="card"><div class="card-title">Daily Breakdown</div>';
  var reversed = trendData.slice().reverse();
  reversed.forEach(function(d) {
    var dateLabel = new Date(d.day + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    html += '<div class="day-row"><span class="day-date">' + dateLabel + '</span><span class="day-stats">';
    html += '<span class="day-best">' + d.best.toFixed(1) + '\u2033</span><span class="day-sep">¬∑</span>';
    html += '<span class="day-avg">' + d.avg.toFixed(1) + '\u2033 avg</span><span class="day-sep">¬∑</span>';
    html += '<span class="day-count">' + d.count + '</span></span></div>';
  });
  html += '</div>';
  container.innerHTML = html;
  requestAnimationFrame(function() { drawChart(trendData); });
}

function drawChart(data) {
  var canvas = document.getElementById('trendChart');
  if (!canvas) return;
  var dpr = window.devicePixelRatio || 1;
  var W = Math.max(data.length * 60, canvas.parentElement.clientWidth);
  var H = 220;
  canvas.width = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  var ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  var pad = { top: 16, right: 16, bottom: 36, left: 36 };
  var cw = W - pad.left - pad.right;
  var ch = H - pad.top - pad.bottom;
  var allVals = [];
  data.forEach(function(d) { allVals.push(d.best, d.avg, d.rolling7); });
  var minV = Math.floor(Math.min.apply(null, allVals) - 1);
  var maxV = Math.ceil(Math.max.apply(null, allVals) + 1);
  var range = maxV - minV || 1;
  var xStep = data.length > 1 ? cw / (data.length - 1) : cw;
  function x(i) { return pad.left + i * xStep; }
  function y(v) { return pad.top + ch - ((v - minV) / range) * ch; }

  ctx.strokeStyle = '#252d45'; ctx.lineWidth = 0.5;
  for (var i = 0; i <= 5; i++) {
    var val = minV + (range * i / 5); var yy = y(val);
    ctx.beginPath(); ctx.moveTo(pad.left, yy); ctx.lineTo(W - pad.right, yy); ctx.stroke();
    ctx.fillStyle = '#4a5170'; ctx.font = '10px DM Sans, sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(val.toFixed(0), pad.left - 6, yy + 3);
  }
  ctx.fillStyle = '#4a5170'; ctx.font = '10px DM Sans, sans-serif'; ctx.textAlign = 'center';
  data.forEach(function(d, i) {
    var lbl = new Date(d.day + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    ctx.fillText(lbl, x(i), H - pad.bottom + 20);
  });

  ctx.setLineDash([5, 4]); ctx.strokeStyle = '#2dd881'; ctx.lineWidth = 2;
  ctx.beginPath();
  data.forEach(function(d, i) { i === 0 ? ctx.moveTo(x(i), y(d.rolling7)) : ctx.lineTo(x(i), y(d.rolling7)); });
  ctx.stroke(); ctx.setLineDash([]);

  ctx.strokeStyle = '#ffc44a'; ctx.lineWidth = 2; ctx.beginPath();
  data.forEach(function(d, i) { i === 0 ? ctx.moveTo(x(i), y(d.best)) : ctx.lineTo(x(i), y(d.best)); });
  ctx.stroke();
  data.forEach(function(d, i) { ctx.beginPath(); ctx.arc(x(i), y(d.best), 4, 0, Math.PI * 2); ctx.fillStyle = '#ffc44a'; ctx.fill(); });

  ctx.strokeStyle = '#4a8eff'; ctx.lineWidth = 2; ctx.beginPath();
  data.forEach(function(d, i) { i === 0 ? ctx.moveTo(x(i), y(d.avg)) : ctx.lineTo(x(i), y(d.avg)); });
  ctx.stroke();
  data.forEach(function(d, i) { ctx.beginPath(); ctx.arc(x(i), y(d.avg), 4, 0, Math.PI * 2); ctx.fillStyle = '#4a8eff'; ctx.fill(); });
}

// ======== ZOOM & PAN ========
var currentZoom = 1;
var panX = 0;
var panY = 0;
var isPanning = false;
var panStartX = 0;
var panStartY = 0;
var panOffsetX = 0;
var panOffsetY = 0;

function setZoom(level) {
  currentZoom = level;
  if (level === 1) { panX = 0; panY = 0; }
  applyTransform();
  // Update button states
  document.querySelectorAll('.zoom-btn').forEach(function(btn) {
    btn.classList.remove('active');
    if (btn.textContent === level + '√ó') btn.classList.add('active');
  });
}

function resetPan() {
  panX = 0; panY = 0;
  applyTransform();
}

function applyTransform() {
  video.style.transform = 'scale(' + currentZoom + ') translate(' + (panX / currentZoom) + 'px, ' + (panY / currentZoom) + 'px)';
}

// Touch pan when zoomed
var videoBox = document.getElementById('videoBox');
videoBox.addEventListener('touchstart', function(e) {
  if (currentZoom <= 1 || e.touches.length !== 1) return;
  isPanning = true;
  panStartX = e.touches[0].clientX - panX;
  panStartY = e.touches[0].clientY - panY;
  e.preventDefault();
}, { passive: false });

videoBox.addEventListener('touchmove', function(e) {
  if (!isPanning || e.touches.length !== 1) return;
  panX = e.touches[0].clientX - panStartX;
  panY = e.touches[0].clientY - panStartY;
  // Clamp pan based on zoom
  var maxPan = (currentZoom - 1) * 120;
  panX = Math.max(-maxPan, Math.min(maxPan, panX));
  panY = Math.max(-maxPan, Math.min(maxPan, panY));
  applyTransform();
  e.preventDefault();
}, { passive: false });

videoBox.addEventListener('touchend', function() { isPanning = false; });

// ======== KEYBOARD ========
document.addEventListener('keydown', function(e) {
  if (!videoLoaded) return;
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
  if (e.key === 'ArrowLeft') { e.preventDefault(); stepFrame(e.shiftKey ? -10 : -1); }
  if (e.key === 'ArrowRight') { e.preventDefault(); stepFrame(e.shiftKey ? 10 : 1); }
  if (e.key === 'a' || e.key === 'A') { e.preventDefault(); markTakeoff(); }
  if (e.key === 'l' || e.key === 'L') { e.preventDefault(); markLanding(); }
  if (e.key === 'c' || e.key === 'C') { e.preventDefault(); markContactIn(); }
  if (e.key === 'o' || e.key === 'O') { e.preventDefault(); markContactOut(); }
});

// ======== INIT ========
loadJumps();
</script>
</body>
</html>
